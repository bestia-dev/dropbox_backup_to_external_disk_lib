<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="decrypt dropbox api token from file or use the oauth2 “PKCE code workflow” to get the access token and encrypt it and save into file"><title>dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../static.files/rustdoc-84e720fa.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="dropbox_backup_to_external_disk_lib" data-themes="" data-resource-suffix="" data-rustdoc-version="1.89.0 (29483883e 2025-08-04)" data-channel="1.89.0" data-search-js="search-92309212.js" data-settings-js="settings-5514c975.js" ><script src="../../static.files/storage-4e99c027.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-fd3af306.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-32bb7600.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../dropbox_backup_to_external_disk_lib/index.html">dropbox_<wbr>backup_<wbr>to_<wbr>external_<wbr>disk_<wbr>lib</a><span class="version">2.1.135</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module dropbox_<wbr>api_<wbr>token_<wbr>with_<wbr>oauth2_<wbr>mod</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#decrypt-dropbox-api-token-from-file-or-use-the-oauth2-pkce-code-workflow-to-get-the-access-token-and-encrypt-it-and-save-into-file" title="decrypt dropbox api token from file or use the oauth2 “PKCE code workflow” to get the access token and encrypt it and save into file">decrypt dropbox api token from file or use the oauth2 “PKCE code workflow” to get the access token and encrypt it and save into file</a><ul><li><a href="#secrets" title="Secrets">Secrets</a></li><li><a href="#copy-code-instead-of-dependency-crate" title="Copy code instead of dependency crate">Copy code instead of dependency crate</a></li><li><a href="#store-encrypted-secret-to-file" title="Store encrypted secret to file">Store encrypted secret to file</a></li><li><a href="#in-memory-protection" title="In memory protection">In memory protection</a></li><li><a href="#encrypt_decrypt_with_ssh_key_mod" title="encrypt_decrypt_with_ssh_key_mod">encrypt_decrypt_with_ssh_key_mod</a></li><li><a href="#other-dependencies" title="Other dependencies">Other dependencies</a></li></ul></li></ul><h3><a href="#structs">Module Items</a></h3><ul class="block"><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#constants" title="Constants">Constants</a></li><li><a href="#statics" title="Statics">Statics</a></li><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="../index.html">In crate dropbox_<wbr>backup_<wbr>to_<wbr>external_<wbr>disk_<wbr>lib</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../index.html">dropbox_backup_to_external_disk_lib</a></div><h1>Module <span>dropbox_api_token_with_oauth2_mod</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../src/dropbox_backup_to_external_disk_lib/dropbox_api_token_with_oauth2_mod.rs.html#5-399">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="decrypt-dropbox-api-token-from-file-or-use-the-oauth2-pkce-code-workflow-to-get-the-access-token-and-encrypt-it-and-save-into-file"><a class="doc-anchor" href="#decrypt-dropbox-api-token-from-file-or-use-the-oauth2-pkce-code-workflow-to-get-the-access-token-and-encrypt-it-and-save-into-file">§</a>decrypt dropbox api token from file or use the oauth2 “PKCE code workflow” to get the access token and encrypt it and save into file</h2>
<p>Dropbox offers the preferred OAuth2 “PKCE with code flow” for client applications.
In clients that run on the client machine it is impossible to hide secrets.
So there is the new recommended PKCE “pixie” (Proof Key for Code Exchange) to the rescue.
<a href="https://dropbox.tech/developers/pkce--what-and-why-">https://dropbox.tech/developers/pkce--what-and-why-</a></p>
<h3 id="secrets"><a class="doc-anchor" href="#secrets">§</a>Secrets</h3>
<p>In this module there will be a lot of work with secrets.<br />
It is difficult to trust an external crate with your secrets.<br />
External crates can get updated unexpectedly and change to malicious code.</p>
<h3 id="copy-code-instead-of-dependency-crate"><a class="doc-anchor" href="#copy-code-instead-of-dependency-crate">§</a>Copy code instead of dependency crate</h3>
<p>It is best to have the Rust code under your fingertips when dealing with secrets.<br />
Than you know, nobody will touch this code except of you.<br />
You can copy this code directly into your codebase as a module,
inspect and review it and know exactly what is going on.<br />
The code is as linear and readable with comments as possible.</p>
<h3 id="store-encrypted-secret-to-file"><a class="doc-anchor" href="#store-encrypted-secret-to-file">§</a>Store encrypted secret to file</h3>
<p>The secrets will be encrypted with an ssh private key and stored in the <code>~/.ssh</code> folder.<br />
This way the data is protected at rest in storage drive.</p>
<h3 id="in-memory-protection"><a class="doc-anchor" href="#in-memory-protection">§</a>In memory protection</h3>
<p>This is a tough one! There is no 100% software protection of secrets in memory.<br />
Theoretically an attacker could dump the memory in any moment and read the secrets.<br />
There is always a moment when the secret is used in its plaintext form. This cannot be avoided.
All we can do now is to be alert what data is secret and take better care of it.<br />
Every variable that have secrets will have the word <code>secret</code> in it.
When a variable is confusing I will use the word <code>plain</code> to express it is <code>not a secret</code>.
To avoid leaking in logs I will use the <code>secrecy</code> crate. This is not 100% protection. It is important just to express intent when the secrets are really used.<br />
<code>Secrecy</code> needs the trait <code>zeroize</code> to empty the memory after use for better memory hygiene.
I will add the type names explicitly to emphasis the secrecy types used.</p>
<h3 id="encrypt_decrypt_with_ssh_key_mod"><a class="doc-anchor" href="#encrypt_decrypt_with_ssh_key_mod">§</a>encrypt_decrypt_with_ssh_key_mod</h3>
<p>This module depends on the generic module for encryption <code>encrypt_decrypt_with_ssh_key_mod.rs</code>. That module also needs to be copy and paste into your project.</p>
<h3 id="other-dependencies"><a class="doc-anchor" href="#other-dependencies">§</a>Other dependencies</h3>
<p>In <code>Cargo.toml</code> there are a group od dependencies needed for this to work. They are so generic that I don’t expect any malware in them to be able to steal some usable secrets.</p>
<p>Beware that the versions of crates in <code>Cargo.toml</code> are not precisely pinpointed. In rust the symbol ‘=’ means “the same major number equal or newer to”. This means from one compilation to another, it can automatically change to a newer version without the programmer even noticing it.</p>
<p>This is great if the newer version is solving some security issue. But this is super-bad if the newer version is malware supply chain attack. We have no idea how to distinguish one from another.</p>
<p>Just to mention: there exists the trick to control the <code>Cargo.lock</code> file and forbid the change of the version number, but more times than not, you will not want to commit the lock file into the Dropbox repository.</p>
<div class="example-wrap"><pre class="language-toml"><code>[dependencies]
reqwest={version=&quot;0.12.12&quot;, features=[&quot;json&quot;,&quot;blocking&quot;]}
serde ={ version= &quot;1.0.217&quot;, features=[&quot;std&quot;,&quot;derive&quot;]}
serde_json = &quot;1.0.138&quot;
ssh-key = { version = &quot;0.6.7&quot;, features = [ &quot;rsa&quot;, &quot;encryption&quot;,&quot;ed25519&quot;] }
ssh_agent_client_rs_git_bash = &quot;0.0.19&quot;
rsa = { version = &quot;0.9.7&quot;, features = [&quot;sha2&quot;,&quot;pem&quot;] }
zeroize = {version=&quot;1.8.1&quot;, features=[&quot;derive&quot;]}
aes-gcm = &quot;0.10.3&quot;
base64ct = {version = &quot;1.6.0&quot;, features = [&quot;alloc&quot;] }
secrecy = &quot;0.10.3&quot;
chrono =&quot;0.4.39&quot;
crossplatform_path=&quot;1.1.1&quot;</code></pre></div></div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.DropboxApiConfig.html" title="struct dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::DropboxApiConfig">Dropbox<wbr>ApiConfig</a></dt><dt><a class="struct" href="struct.SecretResponseAccessToken.html" title="struct dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::SecretResponseAccessToken">Secret<wbr>Response<wbr>Access<wbr>Token</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt></dl><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">§</a></h2><dl class="item-table"><dt><a class="constant" href="constant.BLUE.html" title="constant dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::BLUE">BLUE</a></dt><dd>ANSI color</dd><dt><a class="constant" href="constant.GREEN.html" title="constant dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::GREEN">GREEN</a></dt><dd>ANSI color</dd><dt><a class="constant" href="constant.RED.html" title="constant dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::RED">RED</a></dt><dd>ANSI color</dd><dt><a class="constant" href="constant.RESET.html" title="constant dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::RESET">RESET</a></dt><dd>ANSI color</dd><dt><a class="constant" href="constant.YELLOW.html" title="constant dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::YELLOW">YELLOW</a></dt><dd>ANSI color</dd></dl><h2 id="statics" class="section-header">Statics<a href="#statics" class="anchor">§</a></h2><dl class="item-table"><dt><a class="static" href="static.DROPBOX_API_CONFIG.html" title="static dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::DROPBOX_API_CONFIG">DROPBOX_<wbr>API_<wbr>CONFIG</a></dt><dd>Application state (static) is initialized only once in the main() function.</dd></dl><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.authenticate_with_browser_and_save_file.html" title="fn dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::authenticate_with_browser_and_save_file">authenticate_<wbr>with_<wbr>browser_<wbr>and_<wbr>save_<wbr>file</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt><dt><a class="fn" href="fn.authentication_with_browser.html" title="fn dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::authentication_with_browser">authentication_<wbr>with_<wbr>browser</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt><dd>Oauth2 PKCE code flow needs to be authenticated with a browser
<a href="https://dropbox.tech/developers/pkce--what-and-why-">https://dropbox.tech/developers/pkce--what-and-why-</a></dd><dt><a class="fn" href="fn.decrypt_text_with_metadata.html" title="fn dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::decrypt_text_with_metadata">decrypt_<wbr>text_<wbr>with_<wbr>metadata</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt><dd>decrypt text with metadata</dd><dt><a class="fn" href="fn.dropbox_api_config_initialize.html" title="fn dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::dropbox_api_config_initialize">dropbox_<wbr>api_<wbr>config_<wbr>initialize</a></dt><dd>Application state (static) is initialized only once in the main() function.</dd><dt><a class="fn" href="fn.encrypt_and_save_file.html" title="fn dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::encrypt_and_save_file">encrypt_<wbr>and_<wbr>save_<wbr>file</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt><dd>encrypt and save file</dd><dt><a class="fn" href="fn.get_dropbox_secret_token.html" title="fn dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::get_dropbox_secret_token">get_<wbr>dropbox_<wbr>secret_<wbr>token</a></dt><dd>Start the dropbox oauth2 PKCE code workflow
It will use the private key from the .ssh folder.
The encrypted file has the same file name with the “.enc” extension.
Returns access_token to use as bearer for api calls</dd><dt><a class="fn" href="fn.refresh_tokens.html" title="fn dropbox_backup_to_external_disk_lib::dropbox_api_token_with_oauth2_mod::refresh_tokens">refresh_<wbr>tokens</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt><dd>use refresh token to get new access_token and refresh_token</dd></dl></section></div></main></body></html>